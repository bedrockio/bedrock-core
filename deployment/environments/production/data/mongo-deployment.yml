apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongo
  template:
    metadata:
      labels:
        app: mongo
    spec:
      initContainers:
        - name: volume-permissions
          image: busybox
          imagePullPolicy: Always
          command: ["sh", "-c", "chown -R 1000:1000 /data/db"]
          securityContext:
            privileged: true
          volumeMounts:
            - name: mongo-persistent-storage
              mountPath: /data/db
        - name: sysctl
          image: busybox
          imagePullPolicy: Always
          command: ["sysctl", "-w", "vm.max_map_count=262144"]
          securityContext:
            privileged: true
        - name: ulimit
          image: busybox
          imagePullPolicy: Always
          command: ["sh", "-c", "ulimit -n 65536"]
          securityContext:
            privileged: true
      containers:
        - image: mongo:7.0.4
          name: main
          # resources:
          #   limits:
          #     cpu: "8000m"
          #     memory: "32Gi"
          ports:
            - name: mongo
              containerPort: 27017
              hostPort: 27017
          volumeMounts:
            - name: mongo-persistent-storage
              mountPath: /data/db
      volumes:
        - name: mongo-persistent-storage
          gcePersistentDisk:
            pdName: mongo-disk
            fsType: ext4
